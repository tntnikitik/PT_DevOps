# Инструкция
Протестировано на: Ubuntu 22.04

Тестирование проводилось на трех машинах:
1. Машина, где разворачивается бот и выполняется playbook
2. Машина, где разворачивается база данных
3. Машина, на которую производится репликация базы данных.

Для мониторинга была выбрана машина, на которой разворачивалась база данных, из-за невозможности запустить четвертую машину в силу ограниченных ресурсов компьютера

На машине, на которой будет выполнятся playbook, необходимо:
1. Установить утилиты sshpass и ansible (в соответствии с практической частью лекции 4.4)
2. Клонировать ветку этого репозитория с помощью команды git clone --branch ansible https://github.com/tntnikitik/PT_DevOps
3. Перейти в папку клонированного репозитория.
4. Создать в этой папке файл secrets.yaml согласно шаблону, внести значения для тестирования.
5. Перед запуском в терминале, открытом внутри этой папки, стоит прописать ```export PATH=$PATH:/home/user/.local/bin```, где user - текущий пользователь.
   
На всех трех машинах небходимо сделать следующее:
1. Выполнить команду sudo visudo
2. В открывшемся файле в самый конец добавить строку вида <user> ALL=(ALL:ALL) NOPASSWD:ALL, где <user> - пользователь, через которого подключается playbook.
3. Убедиться в том, что сервис ssh установлен и запущен.

После всех проверки всех необходимых настроек можно выполнять запуск (выполняется из скачанной папки). Команда для запуска: ``` ansible-playbook playbook_tg_bot.yml -i inventory -e @secrets.yaml ```

МЕНЯТЬ РАСПОЛОЖЕНИЕ ФАЙЛОВ В ПАПКАХ С БОТОМ И С ФАЙЛАМИ ANSIBLE НЕ РЕКОМЕНДУЕТСЯ.

# Шаблон secrets.yaml:
```
invent:
  bot:
    host: <ip-адрес машины, на которой разворачивается бот>
    user: <user, под которым выполняется подключение>
    password: <пароль пользователя, под которым выполняется подключение>
    bot_directory: <Папка, в которую будет произведено клонирование бота с GitHub
								    ДОЛЖНА БЫТЬ ПУСТОЙ>
  db:
    host: <ip-адрес машины, на которой разворачивается база данных>
    user: <user, под которым выполняется подключение>
    password: <пароль пользователя, под которым выполняется подключение>
  db_repl:
    host: <ip-адрес машины, на которую выполняется репликация базы данных>
    user: <user, под которым выполняется подключение>
    password: <пароль пользователя, под которым выполняется подключение>

remote_access:
  host: <ip-адрес машины, мониторинг которой будет производиться>
  port: 22 #В случае, если порт ssh нестандартный - изменить на свой
  user: <user, под которым выполняется подключение>
  password: <пароль пользователя, под которым выполняется подключение>

databases:
  master:
    database: db_bot
    port: 5432
    user: postgres #оставить так
    password: qwerty #менять по желанию
  replica:
    port: 5432
    user: repl_user #оставить так
    password: qwerty #менять по желанию

telegram:
  token: <токен бота, который будет отдельно прикреплен к письму и в Notion>
```
